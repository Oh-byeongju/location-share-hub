<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="marker">
    <resultMap id="hashMapVO" type="com.sjinc.bss.framework.data.HashMapVO"/>
    <resultMap id="hashMapResultVO" type="com.sjinc.bss.framework.data.HashMapResultVO"/>

    <!--    마커 상세 조회 쿼리-->
    <select id="selectMarkerAllById" parameterType="int" resultMap="hashMapResultVO">
        SELECT mm.marker_no, mm.user_id, mu.user_nm, mm.marker_nm, mm.marker_address, sc.cd_nm, mm.marker_text, mm.insert_dt
        FROM map_marker mm INNER JOIN map_user mu ON mm.user_id = mu.user_id INNER JOIN sy_cmm_cd sc ON mm.marker_type_cd = sc.cd
        WHERE mm.marker_no = #{markerNo}
    </select>

<!--    특정 마커 검색 쿼리-->
    <select id="selectMarkerById" parameterType="java.util.Map" resultType="int">
        SELECT mm.marker_no
        FROM map_marker mm
        WHERE mm.marker_no = #{markerNo}
    </select>

<!--    마커 즐겨찾기 검색 쿼리-->
    <select id="getMapBookmark" parameterType="java.util.Map" resultType="int">
        SELECT mb.marker_no
        FROM map_bookmark mb
        WHERE user_id = #{userId} AND marker_no = #{markerNo}
    </select>

<!--    마커 즐겨찾기 생성 쿼리-->
    <insert id="insertMapBookmark" parameterType="java.util.Map">
        INSERT INTO map_bookmark (
            user_id, marker_no, insert_dt, insert_id, insert_ip, update_dt, update_id, update_ip
        )
        VALUES (
                   #{userId}, #{markerNo}, NOW(), #{userId}, #{insertIP}, NULL, NULL, NULL
               )
    </insert>

<!--    마커 즐겨찾기 삭제 쿼리-->
    <delete id="deleteMapBookmark" parameterType="java.util.Map">
        DELETE
        FROM map_bookmark
        WHERE user_id = #{userId} AND marker_no = #{markerNo}
    </delete>

<!--    마커 삭제 쿼리-->
    <delete id="deleteMarker" parameterType="java.util.Map">
        DELETE
        FROM map_marker
        WHERE marker_no = #{markerNo}
    </delete>

<!--    마커 리뷰 조회 쿼리-->
    <select id="selectMarkerReviews" parameterType="int" resultMap="hashMapResultVO">
        select mmr.marker_review_no, mmr.user_id, mu.user_nm, mmr.marker_review_text, mmr.marker_review_dts
        from map_marker_review mmr inner join map_user mu on mmr.user_id = mu.user_id
        where marker_no = #{markerNo}
        order by marker_review_dts desc;
    </select>

<!--    마커 리뷰 좋아요 개수 조회 쿼리-->
    <select id="selectLikeCountByReview" resultMap="hashMapResultVO">
        SELECT marker_review_no, COUNT(*) AS like_count
        FROM map_review_like
        GROUP BY marker_review_no
    </select>

<!--    사용자가 좋아요한 마커 조회-->
    <select id="selectMarkerReviewNosByUser" parameterType="String" resultType="int">
        SELECT marker_review_no
        FROM map_review_like
        WHERE user_id = #{userId}
    </select>

    <!--    사용자가 작성한 리뷰 검색 쿼리-->
    <select id="getMapReview" parameterType="java.util.Map" resultType="int">
        SELECT marker_review_no
        FROM map_marker_review
        WHERE user_id = #{userId} AND marker_no = #{markerNo}
    </select>

    <!-- 마커 리뷰 insert 쿼리 -->
    <insert id="insertMarkerReview" parameterType="java.util.Map">
        INSERT INTO map_marker_review (
            user_id, marker_no, marker_review_text, marker_review_dts,
            insert_dt, insert_id, insert_ip, update_dt, update_id, update_ip
        )
        VALUES (
                   #{userId}, #{markerNo}, #{markerReviewText}, NOW(),
                   NOW(), #{userId}, #{insertIp}, NULL, NULL, NULL
               )
    </insert>

    <select id="selectMarkerReviewNo" parameterType="java.util.Map" resultType="int">
        SELECT marker_review_no
        FROM map_marker_review mmr
        WHERE marker_review_no = #{markerReviewNo}
    </select>

    <select id="selectMarkerReviewNo2" parameterType="java.util.Map" resultType="int">
        SELECT marker_review_no
        FROM map_review_like mrl
        WHERE marker_review_no = #{markerReviewNo} AND user_id = #{userId}
    </select>

    <insert id="insertReviewLike" parameterType="java.util.Map">
        INSERT INTO map_review_like (
            user_id, marker_review_no, insert_dt, insert_id, insert_ip,
            update_dt, update_id, update_ip
        )
        VALUES (
                   #{userId}, #{markerReviewNo}, NOW(), #{userId}, #{insertIp},
                   NULL, NULL, NULL
               )
    </insert>

    <delete id="deleteMarkerReview" parameterType="java.util.Map">
        DELETE
        FROM map_review_like
        WHERE marker_review_no = #{markerReviewNo} AND user_id = #{userId}
    </delete>

    <delete id="deleteMarkerReviewReal" parameterType="java.util.Map">
        DELETE
        FROM map_marker_review
        WHERE marker_review_no = #{markerReviewNo}
    </delete>
</mapper>