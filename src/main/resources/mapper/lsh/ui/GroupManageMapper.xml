<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="groupManage">
    <resultMap id="hashMapVO" type="com.lsh.framework.data.HashMapVO"/>
    <resultMap id="hashMapResultVO" type="com.lsh.framework.data.HashMapResultVO"/>

<!--    그룹 검색 쿼리-->
    <select id="selectByLikeId" parameterType="java.util.Map" resultMap="hashMapResultVO">
        SELECT *
        FROM (
                 SELECT mg.group_id,
                        mg.user_id,
                        mg.group_nm,
                        COUNT(*)           AS group_count,
                        MAX(mg.insert_dt)  AS insert_dt,
                        MAX(mu.user_email) AS user_email
                 FROM map_group mg
                          INNER JOIN map_group_user mgu ON mg.group_id = mgu.group_id
                          INNER JOIN map_user mu ON mg.user_id = mu.user_id
                 WHERE mg.group_nm LIKE '%' || #{groupId, jdbcType=VARCHAR} || '%'
                 GROUP BY mg.group_id, mg.user_id, mg.group_nm
                 ORDER by mg.insert_dt
             )
        WHERE group_id IN (SELECT group_id
                           FROM map_group_user
                           WHERE user_id = #{userId, jdbcType=VARCHAR})
    </select>

    <delete id="deleteReviewLikeByGroupAndUser" parameterType="map">
        DELETE
        FROM map_review_like
        WHERE marker_review_no IN (
            SELECT marker_review_no
            FROM map_marker_review
            WHERE marker_no IN (
                SELECT marker_no
                FROM map_marker
                WHERE group_id = #{groupId, jdbcType=VARCHAR}
            )
        )
        AND user_id = #{userId, jdbcType=VARCHAR}
    </delete>

    <delete id="deleteMarkerReviewByGroupAndUser" parameterType="map">
        DELETE
        FROM map_marker_review
        WHERE marker_no IN (
            SELECT marker_no
            FROM map_marker
            WHERE group_id = #{groupId, jdbcType=VARCHAR}
        )
          AND user_id = #{userId, jdbcType=VARCHAR}
    </delete>

    <delete id="deleteBookmarkByGroupAndUser" parameterType="map">
        DELETE
        FROM map_bookmark
        WHERE marker_no IN (
            SELECT marker_no
            FROM map_marker
            WHERE group_id = #{groupId, jdbcType=VARCHAR}
        )
          AND user_id = #{userId, jdbcType=VARCHAR}
    </delete>

    <delete id="deleteMarkerByGroupAndUser" parameterType="map">
        DELETE
        FROM map_marker
        WHERE group_id = #{groupId, jdbcType=VARCHAR}
        AND user_id = #{userId, jdbcType=VARCHAR}
    </delete>

    <delete id="deleteGroupUserByGroupAndUser" parameterType="map">
        DELETE
        FROM map_group_user
        WHERE group_id = #{groupId, jdbcType=VARCHAR}
          AND user_id = #{userId, jdbcType=VARCHAR}
    </delete>






<!--    그룹 가입 쿼리(그룹원 등록)-->
    <insert id="joinMapGroupUser" parameterType="java.util.Map">
        INSERT INTO map_group_user (
            group_id, user_id, group_user_rank_cd,
            insert_dt, insert_id, insert_ip, update_dt, update_id, update_ip
        )
        VALUES (
                   #{groupId, jdbcType=VARCHAR}, #{userId, jdbcType=VARCHAR}, #{groupRank, jdbcType=VARCHAR},
                   CURRENT_TIMESTAMP, #{userId, jdbcType=VARCHAR}, #{insertIp, jdbcType=VARCHAR}, NULL, NULL, NULL
               )
    </insert>

<!--    그룹 생성 전 id 중복 확인 쿼리-->
    <select id="selectByGroupId" parameterType="java.lang.String" resultMap="hashMapResultVO">
        select group_id
        from map_group
        where group_id = #{groupId, jdbcType=VARCHAR}
    </select>

<!--    그룹 생성 쿼리-->
    <insert id="createMapGroup" parameterType="java.util.Map">
        INSERT INTO map_group (
            group_id, user_id, group_pw, group_nm,
            group_lat, group_long, group_lev,
            insert_dt, insert_id, insert_ip, update_dt, update_id, update_ip
        )
        VALUES (
                   #{groupId, jdbcType=VARCHAR}, #{userId, jdbcType=VARCHAR}, #{groupPw, jdbcType=VARCHAR}, #{groupNm, jdbcType=VARCHAR},
                   #{groupLat, jdbcType=INTEGER}, #{groupLong, jdbcType=INTEGER}, #{groupLev, jdbcType=INTEGER},
                   CURRENT_TIMESTAMP, #{userId, jdbcType=VARCHAR}, #{insertIp, jdbcType=VARCHAR},
                   NULL, NULL, NULL
               )
    </insert>
</mapper>